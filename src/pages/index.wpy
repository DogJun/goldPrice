<style lang="less">
@import "../styles/variable.less";
@import "../styles/mixin.less";
.header {
  padding: 20rpx;
  .clearfix();
  .header-left {
    .pull-left();
    .logo {
      width: 200rpx;
      height: 50rpx;
      margin-right: 50rpx;
      vertical-align: top;
    }
  }
  .header-right {
    .pull-right();
    .time {
      display: inline-block;
      height: 50rpx;
      font-size: 26rpx;
      line-height: 50rpx;
      color: @themeColor;
      margin-right: 20rpx;
    }
    .txt {
      display: inline-block;
      height: 50rpx;
      font-size: 26rpx;
      line-height: 50rpx;
      color: @themeColor;
    }
  }
}
.table {
  border-bottom: 1rpx solid #ccc;
}
.tr {
  display: flex;
  width: 100%;
  height: 120rpx;
  justify-content: center;
  align-items: center;
}
.td {
  width:40%;
  height: 120rpx;
  line-height: 120rpx;
  justify-content: center;
  text-align: center;
  border-right: 1rpx solid @borderColor;
  &:last-child {
    border-right: 0;
  }
  .td-child {
    height: 60rpx;
    line-height: 60rpx;
    &:first-child {
      border-bottom: 1rpx solid #ccc;
    }
  }
}
.bg-w{
  background: #ddd;
  height: 100rpx;
}
.bg-g{
  background: #ddd;
}
.th {
  width: 40%;
  justify-content: center;
  color: #333;
  display: flex;
  height: 100rpx;
  align-items: center;
}
</style>

<template>
  <view class="index">
    <view class="header">
      <view class="header-left">
        <image class="logo" src="../images/logo.png" />
      </view>
      <view class="header-right">
        <text class="time">{{time}}</text>
        <text class="txt">{{timeRange(OPENSTART, OPENEND) ? '开盘' : '收盘'}}</text>
      </view>
    </view>
    <view class="table">
      <view class="tr bg-w">
        <view class="th">商品</view>
        <view class="th">回购</view>
        <view class="th">销售</view>
        <view class="th">高/低</view>
      </view>
      <block wx:for="{{listData}}" wx:key="{{code}}">
        <view class="tr bg-g" wx:if="{{index % 2 !== 0}}">
          <view class="td">{{item.type}}</view>
          <view class="td">{{item.buy}}</view>
          <view class="td">{{item.sale}}</view>
          <view class="td">
            <view class="td-child">{{item.high}}</view>
            <view class="td-child">{{item.low}}</view>
          </view>
        </view>
        <view class="tr" wx:else>
          <view class="td">{{item.type}}</view>
          <view class="td">{{item.buy}}</view>
          <view class="td">{{item.sale}}</view>
          <view class="td">
            <view class="td-child">{{item.high}}</view>
            <view class="td-child">{{item.low}}</view>
          </view>
        </view>
      </block>
      <!-- todo 广告位跳转 -->
    </view>
    <view class="ad" wx:if="{{adUrl}}">
      <navigator target="miniProgram" open-type="navigate" app-id="wx809ebeea11a3a09a" path="" extra-data="" version="develop">
        <image style="width: 100%; background-color: #eeeeee;" mode="aspectFit" src="{{adUrl}}"></image>
      </navigator>
    </view>
  </view>
</template>

<script>
  import wepy from 'wepy'
  import { OPENSTART, OPENEND } from '../config/index'
  import { addZeros, timeRange } from '../utils/index'
  import { getAd, getLatest } from '@/request/api'
  export default class Index extends wepy.page {
    config = {
      navigationBarTitleText: '行情'
    }
    components = {}
    data = {
      time: '',
      timeId: null,
      listData: [],
      adUrl: ''
    }
    computed = {}
    methods = {}
    events = {}
    onLoad () {
      let self = this
      self.toLogin()
      // 显示定时器
      this.timeId = setInterval(function() {
        let time = new Date()
        let m = time.getMonth() + 1
        let t = `${time.getFullYear()}/${m.toString().padStart(2, '0')}/${time.getDate().toString().padStart(2, '0')} ${time.getHours().toString().padStart(2, '0')}:${time.getMinutes().toString().padStart(2, '0')}:${time.getSeconds().toString().padStart(2, '0')}`
        self.time = t
        self.$apply()
      }, 1000)
      this._getAd()
      // 建立websocket连接
      wx.connectSocket({
        url: 'wss://jewelry.timovips.com/webSocketServer1s',
        data:{
        },
        header:{
          'content-type': 'application/x-www-form-urlencoded'
        },
        method: "POST",
        success: async function (res) {
          // getLatest
          console.log(res)
          // await getLatest({
          //   query: {
          //   },
          //   type: 'GET'
          // })
        },
        fail: function (err) {
          console.log(err)
        }
      })
      wx.onSocketOpen(function (res) {
        console.log('WebSocket连接已打开！')
      })
      wx.onSocketError(function (err) {
        console.log('WebSocket连接打开失败，请检查！')
        getLatest().then(res => {
          console.log('getLatest', res)
          self.handleData(res.data.data)
        })
        // if (res.code === 0) {
        //
        // } else {
        //   console.log(res.msg)
        // }
      })
    }
    async toLogin () {
      //检查小程序登录,查看上文中的checkLoginState,如果登录状态失效，那么重新掉起login 方法登录
      await this.$parent.checkLoginState()
    }
    _getAd () {
      getAd({type: '1'}).then(res => {
        console.log('getAd', res.data.imgurl[0].fileUrl)
      })
    }
    handleData (data) {
      console.log(data)
      let result = [
        {
          'type': '黄金',
          'buy': data.goldBuy,
          'sale': data.goldSale,
          'high': data.goldHigh,
          'low': data.goldLow
        },
        {
          'type': '白银',
          'buy': data.byGoldBuy,
          'sale': data.byGoldSale,
          'high': data.byGoldHigh,
          'low': data.byGoldLow
        },
        {
          'type': '铂金',
          'buy': data.bjGoldBuy,
          'sale': data.bjGoldSale,
          'high': data.bjGoldHigh,
          'low': data.bjGoldLow
        },
        {
          'type': '港金',
          'buy': data.hkGoldBuy,
          'sale': data.hkGoldSale,
          'high': data.hkGoldHigh,
          'low': data.hkGoldLow
        },
        {
          'type': '伦敦金',
          'buy': data.londonGoldBuy,
          'sale': data.londonGoldSale,
          'high': data.londonGoldHigh,
          'low': data.londonGoldLow
        }
      ]
      this.listData = result
    }
    onUnload () {
      this.timeId = null
    }
  }
</script>
